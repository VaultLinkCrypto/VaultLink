<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VaultLink Admin - Enterprise Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 30px; background: #f0f2f5; color: #1c1e21; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .controls { display: flex; gap: 10px; align-items: center; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        th { background: #007bff; color: white; padding: 15px; text-align: left; font-size: 13px; text-transform: uppercase; cursor: pointer; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 13px; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .page_view { background: #e7f3ff; color: #1877f2; }
        .copy_click { background: #e7f4e4; color: #25a115; }
        .timestamp { color: #65676b; font-family: monospace; }
        button { border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-csv { background: #28a745; color: white; }
        .btn-csv:hover { background: #218838; }
        #counter { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h2 style="margin:0">VaultLink Analytics</h2>
            <p style="margin:5px 0 0; font-size:12px; color:gray;">Showing last 1000 events | <span id="status">Connecting...</span></p>
        </div>
        <div class="controls">
            <span>Records: <span id="counter">0</span></span>
            <button class="btn-csv" onclick="downloadCSV()">Export CSV</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>User</th> 
                <th>Event</th>
                <th>Coin</th>
                <th>Location</th>
                <th>IP</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody id="data-table"></tbody>
    </table>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAH3Ya_RPF3H5ZCI2pjPKAn5vqfPQF7BOo",
            authDomain: "vaultlinkcrypto.firebaseapp.com",
            databaseURL: "https://vaultlinkcrypto-default-rtdb.firebaseio.com",
            projectId: "vaultlinkcrypto",
            storageBucket: "vaultlinkcrypto.firebasestorage.app",
            messagingSenderId: "197889276270",
            appId: "1:197889276270:web:e74637ae83144aae5fa97f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tableBody = document.getElementById('data-table');
        const statusMsg = document.getElementById('status');
        const counterDisp = document.getElementById('counter');
        
        let recordCount = 0;

        // 1. Setup Reference - Look at 'clicks'
        const clicksRef = db.ref('clicks').limitToLast(1000);

        // 2. Real-time Listener
        clicksRef.on('child_added', (snapshot) => {
            const data = snapshot.val();
            statusMsg.innerText = "Connected - Live";
            statusMsg.style.color = "green";
            
            recordCount++;
            counterDisp.innerText = recordCount;

            const dateObj = new Date(data.timestamp);
            const displayDate = !isNaN(dateObj) ? dateObj.toLocaleString() : (data.date + " " + (data.time || ""));

            const row = tableBody.insertRow(0); // Newest at top
            row.innerHTML = `
                <td><strong style="color:#007bff">${data.user_id || 'Legacy'}</strong></td>
                <td><span class="badge ${data.event || 'view'}">${(data.event || 'view').replace('_', ' ')}</span></td>
                <td><strong>${(data.coin || 'N/A').toUpperCase()}</strong></td>
                <td>${data.location || 'Unknown'}</td>
                <td><code>${data.ip || '0.0.0.0'}</code></td>
                <td class="timestamp">${displayDate}</td>
            `;
        });

        // 3. CSV Export Function
        function downloadCSV() {
            let csv = 'User,Event,Coin,Location,IP,Timestamp\n';
            const rows = tableBody.querySelectorAll("tr");
            
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                const rowData = Array.from(cols).map(c => `"${c.innerText.trim().replace(/"/g, '""')}"`);
                csv += rowData.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.setAttribute("hidden", "");
            a.setAttribute("href", url);
            a.setAttribute("download", `vaultlink_analytics_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
